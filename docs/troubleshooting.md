# トラブルシューティング - パン・チルトカメラマウント

**作成日**: 2025-12-14
**状態**: 電源トラブル対応中

---

## プロジェクト概要

書籍原稿（第12章）の技術検証プロジェクト。Raspberry Pi 5とAdafruit Servo HATを使用したパン・チルトカメラマウントの構築。

### 使用ハードウェア
- Raspberry Pi 5
- Adafruit 16-Channel PWM / Servo HAT for Raspberry Pi
- SG90サーボモーター × 2個（パン・チルト用）
- サーボ用電源: 5V 4A（JetsonNano用を流用）
- Raspberry Pi カメラモジュール v3

### サーボ接続構成（最終確定）
- **チャンネル0**: パンサーボ（左右）
- **チャンネル1**: チルトサーボ（上下）
- **チャンネル2-15**: 未使用
- **注意**: チャンネル1のドライバは初期に故障の疑いがあったが、モーター交換後は正常動作

---

## 実施した作業（時系列）

### 1. 環境セットアップ
✓ システム更新
```bash
sudo apt update && sudo apt upgrade -y
```

✓ I2Cの有効化
```bash
sudo raspi-config nonint do_i2c 0
```

✓ 必要なPythonライブラリのインストール
```bash
sudo pip3 install adafruit-circuitpython-pca9685 --break-system-packages
sudo pip3 install adafruit-circuitpython-motor --break-system-packages
```

### 2. プログラムの作成
✓ `servo_initial_position_setup.py` を作成（原稿のコードをそのまま使用）

### 3. ハードウェアのトラブルシューティング

#### 問題1: チャンネルの特定
- **症状**: どのチャンネルにどのサーボが接続されているか不明
- **対処**: チャンネル0～3のスキャンを実施
- **結果**: チャンネル0=パン、チャンネル1=チルトと確定

#### 問題2: サーボモーターの故障
- **症状**: 複数のモーターが動作しない
- **対処**: モーターを交換して動作確認
- **判明**: 故障したモーターが複数あった

#### 問題3: サーボホーンの取り付け
- **対処**: 90度の位置でサーボホーンを取り付け直し
- **結果**: 初期位置設定完了

#### 問題4: パンサーボが右に動かない
- **症状**: パンサーボが左（45度）には動くが、右（135度）には動かない
- **推測**: 機械的な干渉または可動範囲の制限
- **未解決**: この問題は継続中

#### 問題5: チルトサーボが両方同時テスト時に動かない
- **症状**: 単独テストでは動くが、パンと同時テストでは動かない
- **推測**: 電源容量または電力配分の問題
- **未解決**: この問題は継続中

---

## 現在発生中のトラブル

### 【重要】電源ランプが消える問題

**発生状況**:
- サーボモーターを3個接続したところ、HATのモーター駆動用電源ランプが消えた
- 以前は4個接続していても動作していた
- 電源: 5V 4A（容量は十分なはず）

**推定原因**:
1. **過電流保護が作動**（最も可能性が高い）
   - サーボモーターが機械的に引っかかって無理に動こうとした
   - パンサーボが右に動けない状態で過電流が流れた
   - 複数のサーボが同時に大電流を引いた

2. **短絡（ショート）**
   - 配線の接触不良や誤接続

3. **逆起電力**
   - サーボモーターの急停止時に発生

**影響**:
- サーボモーターが動作しない
- プログラムは実行できるが、サーボに電力が供給されていない

---

## Raspberry Pi 再起動後の作業手順

### ステップ1: 電源のリセット（最重要）

**安全な手順**:

1. **Raspberry Piの電源を切る**
   ```bash
   sudo shutdown -h now
   ```

2. **HATのサーボ用電源ケーブルを抜く**
   - 5V 4Aの電源アダプタをHATから外す
   - Raspberry Piの電源は接続したまま

3. **すべてのサーボモーターをHATから外す**
   - チャンネル0のサーボを外す
   - チャンネル1のサーボを外す
   - その他接続されているサーボも外す

4. **10秒ほど待つ**
   - 保護回路のリセット待ち

5. **サーボ用電源ケーブルを再接続**
   - 5V 4AをHATに接続
   - **電源ランプが点灯するか確認** ← 重要

6. **Raspberry Piを起動**
   ```bash
   # 電源ボタンを押す
   ```

### ステップ2: サーボモーターの段階的接続

**電源ランプが点灯した場合**:

1. **パン・チルト用の2個のサーボのみを接続**
   - チャンネル0: パンサーボ（左右）
   - チャンネル1: チルトサーボ（上下）
   - **3個以上は接続しない**

2. **動作確認スクリプトを実行**
   ```bash
   cd /home/pi/work/project/kodansya/12-001-rpi-pan-tilt-camera-mount
   python3 servo_initial_position_setup.py
   ```

3. **メニューから「1」を選択**
   - 両サーボを90度に設定
   - サーボが動くか確認

4. **問題なければ「2」「3」で動作テスト**
   - パンサーボの動作確認
   - チルトサーボの動作確認

**電源ランプが点灯しない場合**:

→ 電源アダプタまたはHATの故障の可能性
→ 別の電源アダプタでテスト
→ 必要に応じてAdafruitのサポートに連絡

### ステップ3: 可動範囲の制限設定

パンサーボが右に動かない問題、およびチルトサーボのロック問題があるため、可動範囲を制限する：

**テスト用スクリプト**:
```python
# パンサーボの範囲を制限
pan_servo.angle = 60   # 左
pan_servo.angle = 90   # 中央
pan_servo.angle = 120  # 右（135度ではなく120度）

# チルトサーボの範囲を制限
tilt_servo.angle = 45   # 下
tilt_servo.angle = 90   # 中央
tilt_servo.angle = 120  # 上（135度ではなく120度）
```

**現在の設定値（servo_control.py）**:
- パンサーボ: 35度～125度（中央: 80度）
- チルトサーボ: 45度～120度（中央: 90度）

**原稿のプログラムを修正する場合**:
- パン: 45度 → 60度に変更
- パン/チルト: 135度 → 120度に変更
- ただし、原稿の正確性を確保するため、修正前に動作確認結果を記録

---

## 既知の問題と回避策

### 1. パンサーボが右（135度）に動かない

**症状**:
- 左（45度）には動く
- 中央（90度）に動く
- 右（135度）には動かない、または引っかかる

**回避策**:
- 可動範囲を制限: 60度～120度
- パン・チルトマウントの組み立てを確認
- サーボホーンの取り付け位置を調整

### 2. チルトサーボが物理的可動域を超えてロック

**発生日**: 2025-12-18
**発生状況**: 別プロジェクト（12-002-pet-monitoring-yolov8）でライブラリとして使用中に発生

**症状**:
- チルトサーボを135度（上端）に移動しようとするとロック（固着）する
- サーボモーターに過負荷がかかり、異音がする
- 手動でも動かなくなる

**原因**:
- パン・チルトマウントの物理的構造により、チルト方向の可動域が制限されている
- 135度まで動かそうとすると機械的干渉が発生

**対処**:
- `servo_control.py` の `TILT_UP` を 135度 → 120度 に変更
- 仕様書（docs/specification.md）を更新

**教訓**:
- ライブラリとして外部プロジェクトで使用する際は、物理的制約を考慮した安全な可動範囲を設定する
- 実機での動作確認を十分に行ってから可動範囲を決定する

### 3. 複数サーボの同時動作で動かない

**症状**:
- 単独では動作する
- 両方同時に動かすと片方しか動かない、または両方動かない

**回避策**:
- サーボを順番に動かす（同時動作を避ける）
- 電源容量を確認（5V 4Aは十分なはず）
- 配線の接触不良を確認

### 4. チャンネル1の誤認識

**症状**:
- 初期調査時、チャンネル1が動かないと判断
- モーター交換後は正常動作

**教訓**:
- サーボモーターの故障とドライバの故障を区別する
- 正常なモーターで各チャンネルを個別にテスト

---

## チェックリスト（再起動後）

### 電源関連
- [ ] サーボ用電源（5V 4A）が接続されている
- [ ] HATの電源ランプが点灯している
- [ ] Raspberry Piが起動している
- [ ] すべてのケーブルがしっかり接続されている

### ハードウェア接続
- [ ] サーボHATがRaspberry Piに正しく装着されている
- [ ] パンサーボがチャンネル0に接続されている
- [ ] チルトサーボがチャンネル1に接続されている
- [ ] カメラモジュールが接続されている

### ソフトウェア
- [ ] I2Cが有効になっている（`ls /dev/i2c*` で確認）
- [ ] 必要なライブラリがインストールされている
- [ ] プログラムファイルが存在する

### 動作確認
- [ ] チャンネル0（パン）が左に動く
- [ ] チャンネル0（パン）が中央に動く
- [ ] チャンネル0（パン）が右に動く（120度まで）
- [ ] チャンネル1（チルト）が下に動く
- [ ] チャンネル1（チルト）が中央に動く
- [ ] チャンネル1（チルト）が上に動く（120度まで）

---

## 緊急時の対処

### 電源ランプが復帰しない場合

1. **別の電源アダプタでテスト**
   - 5V 2A以上の電源を使用
   - USB電源は使用しない（容量不足）

2. **HATの目視確認**
   - 焦げた跡がないか
   - 部品が破損していないか

3. **Raspberry Pi単体での動作確認**
   - HATを外してRaspberry Piが起動するか確認

### サーボモーターが動かない場合

1. **I2C接続の確認**
   ```bash
   sudo i2cdetect -y 1
   ```
   - アドレス0x40にPCA9685が検出されるはず

2. **プログラムの再実行**
   ```bash
   python3 -c "
   import board
   import busio
   from adafruit_pca9685 import PCA9685
   i2c = busio.I2C(board.SCL, board.SDA)
   pca = PCA9685(i2c)
   print('PCA9685 detected')
   "
   ```

3. **サーボモーターの個別確認**
   - 各サーボをチャンネル2や3に接続してテスト

---

## 参考情報

### 使用しているプログラム
- **メインプログラム**: `servo_initial_position_setup.py`
- **仕様書**: `docs/specification.md`
- **原稿**: `chapter12_manuscript.md`（git管理外）

### 関連プロジェクト
- [08-002-rpi-servo-multi-control](https://github.com/Murasan201/08-002-rpi-servo-multi-control)
  - サーボモーター制御の基礎を実施済み

### Adafruitリソース
- [Adafruit 16-Channel PWM/Servo HAT Guide](https://learn.adafruit.com/adafruit-16-channel-pwm-servo-hat-for-raspberry-pi)
- [CircuitPython Servo Library](https://docs.circuitpython.org/projects/motor/en/latest/)

---

## 次回作業時の注意事項

1. **電源ランプを常に確認**
   - プログラム実行前に必ず確認
   - 消えた場合はすぐに作業を中断

2. **段階的な動作確認**
   - いきなり複数サーボを動かさない
   - 1つずつ確認してから次へ

3. **可動範囲の制限**
   - パンサーボは35度～125度に制限
   - チルトサーボは45度～120度に制限（上限を135度→120度に変更済み）
   - 機械的干渉を避ける

4. **原稿の修正記録**
   - 動作確認で問題があった箇所を記録
   - 原稿修正の根拠とする

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-14 | 初版作成（電源トラブル発生時） |
| 2025-12-18 | チルトサーボのロック問題を追加、TILT_UP を 135度→120度に変更 |
